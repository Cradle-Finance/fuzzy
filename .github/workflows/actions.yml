on: [pull_request, push]

name: CI

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Clone repository
      uses: actions/checkout@master
    - name: Run tests
      uses: comigor/actions/dart-test@master
  check-version:
    needs: test
    runs-on: ubuntu-latest
    steps:
    - name: Clone repository
      uses: actions/checkout@master
    - name: Check if version was changed and changelog updated
      uses: docker://mikefarah/yq
      run: |
        git diff HEAD pubspec.yaml | grep -E '\+.*version' || exit 1
        package_version=$(yq r pubspec.yaml version)
        echo "::set-env name=package_version::$package_version"
        echo "::warning::$package_version"
        echo "$package_version"
        cat CHANGELOG.md | grep $version || exit 1
        exit 0
  deploy:
    needs: check-version
    runs-on: ubuntu-latest    
    if: contains(github.ref, 'master')
    steps:    
    - name: Clone repository
      uses: actions/checkout@master          
    - name: Publish to pub.dev
      uses: comigor/actions/pub-publish@master      
      env:
        PUB_CREDENTIALS: ${{ secrets.PUB_CREDENTIALS }}
